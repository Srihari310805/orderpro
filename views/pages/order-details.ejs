<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Details - Order Goods</title>
  <link rel="stylesheet" href="/css/style.css" />
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    body {
      background-color: #f4f6f8;
      font-family: "Poppins", sans-serif;
      padding: 20px;
    }
    .order-details-section {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .order-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .order-table th {
      background-color: #0078d7;
      color: white;
      padding: 12px;
    }
    .order-table td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    .order-table tr:hover {
      background-color: #f1f9ff;
    }
    .table-btn {
      padding: 6px 10px;
      margin: 2px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      color: #fff;
      transition: background 0.2s ease;
    }
    .view { background-color: #28a745; }
    .edit { background-color: #17a2b8; }
    .download { background-color: #0078d7; }
    .delete { background-color: #dc3545; }
    .view:hover { background-color: #218838; }
    .edit:hover { background-color: #138496; }
    .download:hover { background-color: #0063b1; }
    .delete:hover { background-color: #c82333; }
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      justify-content: center; align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 80%;
      max-width: 700px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .close {
      float: right;
      font-size: 22px;
      cursor: pointer;
      color: #333;
    }
    .no-orders {
      text-align: center;
      color: #999;
      padding: 20px;
    }
  </style>
</head>

<body>
  <div class="dashboard-container">
    <header class="dashboard-header">
      <div class="logo-section">
        <img src="/images/box-icon.png" alt="Logo" />
        <h2>Order Goods</h2>
      </div>
    </header>

    <section class="order-details-section">
      <h3>Order Details</h3>

      <table class="order-table" id="ordersTable">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Date</th>
            <th>Party Name</th>
            <th>Route</th>
            <th>Total Amount (‚Çπ)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="ordersBody">
          <tr><td colspan="6" class="no-orders">Loading orders...</td></tr>
        </tbody>
      </table>
    </section>
  </div>

  <!-- Modal for viewing order items -->
  <div id="orderModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <h3>Order Items</h3>
      <table id="orderItemsTable" border="1" width="100%" style="margin-top:10px;border-collapse:collapse;">
        <thead>
          <tr>
            <th>Item Name</th>
            <th>Qty</th>
            <th>Net Rate</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const ordersBody = document.getElementById("ordersBody");
    const modal = document.getElementById("orderModal");
    const modalClose = document.getElementById("closeModal");
    const modalTable = document.getElementById("orderItemsTable").querySelector("tbody");
    let ordersData = [];

    // üß© Load all orders
    async function loadOrders() {
      try {
        const res = await fetch("/api/orders");
        const data = await res.json();
        ordersData = data;
        renderOrders(data);
      } catch (err) {
        console.error("Error loading orders:", err);
        ordersBody.innerHTML = '<tr><td colspan="6" class="no-orders">‚ö†Ô∏è Failed to load orders.</td></tr>';
      }
    }

    // üß© Render the table
    function renderOrders(data) {
      ordersBody.innerHTML = "";
      if (data.length === 0) {
        ordersBody.innerHTML = '<tr><td colspan="6" class="no-orders">No orders found.</td></tr>';
        return;
      }

      const grouped = {};
      data.forEach(item => {
        if (!grouped[item.order_id]) {
          grouped[item.order_id] = {
            route: item.route,
            party_name: item.party_name,
            created_at: item.created_at,
            items: [],
            total: 0
          };
        }
        grouped[item.order_id].items.push(item);
        grouped[item.order_id].total += item.qty * item.netrate;
      });

      for (const [orderId, order] of Object.entries(grouped)) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>#${orderId}</td>
          <td>${new Date(order.created_at).toLocaleDateString("en-IN")}</td>
          <td>${order.party_name}</td>
          <td>${order.route}</td>
          <td>‚Çπ${order.total.toFixed(2)}</td>
          <td>
            <button class="table-btn view" onclick="viewOrder('${orderId}')"><i class="fas fa-eye"></i> View</button>
            <button class="table-btn edit" onclick="editOrder('${orderId}')"><i class="fas fa-edit"></i> Edit</button>
            <button class="table-btn download" onclick="downloadOrder('${orderId}')"><i class="fas fa-download"></i> Download</button>
            <button class="table-btn delete" onclick="deleteOrder('${orderId}')"><i class="fas fa-trash"></i> Delete</button>
          </td>
        `;
        ordersBody.appendChild(tr);
      }
    }

    // üß© View order modal
    function viewOrder(orderId) {
      const order = ordersData.filter(o => o.order_id == orderId);
      modalTable.innerHTML = "";
      order.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.item_name}</td>
          <td>${item.qty}</td>
          <td>${item.netrate}</td>
          <td>‚Çπ${(item.qty * item.netrate).toFixed(2)}</td>
        `;
        modalTable.appendChild(tr);
      });
      modal.style.display = "flex";
    }

    modalClose.onclick = () => modal.style.display = "none";
    window.onclick = (e) => { if (e.target == modal) modal.style.display = "none"; };

    // üß© Edit order
    function editOrder(orderId) {
      window.location.href = `/order-entry?edit=${orderId}`;
    }

    // üß© Download order (CSV / PDF)
    function downloadOrder(orderId) {
      
      window.location.href = `/api/orders/download/${orderId}`;
    }

    // üß© Delete order
    async function deleteOrder(orderId) {
      if (!confirm(`‚ö†Ô∏è Are you sure you want to delete Order #${orderId}?`)) return;

      try {
        const res = await fetch(`/api/orders/${orderId}`, { method: "DELETE" });
        const data = await res.json();

        if (data.success) {
          alert(`‚úÖ ${data.message}`);
          loadOrders(); // refresh list
        } else {
          alert(`‚ùå ${data.message || "Failed to delete order."}`);
        }
      } catch (err) {
        console.error("Delete order error:", err);
        alert("‚ö†Ô∏è Server error while deleting order.");
      }
    }

    // Initialize
    loadOrders();
  </script>
</body>
</html>

